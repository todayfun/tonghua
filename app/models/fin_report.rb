class FinReport < ActiveRecord::Base
  attr_accessible :fd_code, :fd_profit_after_share, :fd_profit_after_tax, :fd_profit_base_share, :fd_repdate,
                  :fd_turnover, :fd_type, :fd_year,
                  :fd_dividend_base_share, :fd_non_liquid_debts, :fd_stkholder_rights,
                  :fd_liquid_debts, :fd_liquid_assets, :fd_cash_and_deposit


  TYPE_Q1 = 4
  TYPE_Q2 = 3
  TYPE_Q3 = 2
  TYPE_ANNUAL = 1
  TYPE_SUM_Q2 = 6
  TYPE_SUM_Q3 = 9

  HK_UNIT=1000000 # 百万
  US_UNIT=10000   # 万

  def self.import_finRpt
    stocks = Stock.all
    stocks.each do |s|
      records = []
      if s.stamp == "us"
        records = import_us_finRpt s
      else
        records = import_hk_finRpt s
      end

      next if records.blank?

      exists = {}
      FinReport.where(fd_code:s.code).all.each do |r|
        uk = "#{r.fd_code},#{r.fd_year},#{r.fd_type}"
        exists[uk] = r
      end

      FinReport.transaction do
        records.each do |item|
           if item[:fd_year].to_i < 2010 || item[:fd_type].blank?
             puts "ignore fd_year<2010: " + item.inspect
             next
           end
          begin
            uk = "#{item[:fd_code]},#{item[:fd_year]},#{item[:fd_type]}"
            if exists[uk]
              exists[uk].update_attributes item
            else
              FinReport.create item
            end
          rescue => err
            puts err
          end
        end
      end
    end
  end

=begin
    美股
    http://stockpage.10jqka.com.cn/WB/finance/
    资产负债表：
    <p id="debt">{"title":["\u93c3\u5815\u68ff\\\u7ec9\u6220\u6d30",["\u603b\u73b0\u91d1","\u4e07\u7f8e\u5143"],["\u5176\u4e2d\uff1a\u73b0\u91d1\u4e0e\u73b0\u91d1\u7b49\u4ef7\u7269","\u4e07\u7f8e\u5143"],["\u77ed\u671f\u6295\u8d44","\u4e07\u7f8e\u5143"],["\u5e94\u6536\u8d26\u6b3e","\u4e07\u7f8e\u5143"],["\u9884\u4ed8\u6b3e\u9879","\u4e07\u7f8e\u5143"],["\u6d41\u52a8\u8d44\u4ea7\u7279\u6b8a\u9879\u76ee","\u4e07\u7f8e\u5143"],["\u6d41\u52a8\u8d44\u4ea7\u5408\u8ba1","\u4e07\u7f8e\u5143"],["\u56fa\u5b9a\u8d44\u4ea7\u51c0\u989d","\u4e07\u7f8e\u5143"],["\u51c0\u65e0\u5f62\u8d44\u4ea7","\u4e07\u7f8e\u5143"],["\u80a1\u6743\u6295\u8d44\u548c\u957f\u671f\u6295\u8d44","\u4e07\u7f8e\u5143"],["\u975e\u6d41\u52a8\u8d44\u4ea7\u7279\u6b8a\u9879\u76ee","\u4e07\u7f8e\u5143"],["\u975e\u6d41\u52a8\u8d44\u4ea7\u5408\u8ba1","\u4e07\u7f8e\u5143"],["\u8d44\u4ea7\u5408\u8ba1","\u4e07\u7f8e\u5143"],["\u5e94\u4ed8\u8d26\u6b3e","\u4e07\u7f8e\u5143"],["\u5e94\u4ed8\u8d1f\u503a","\u4e07\u7f8e\u5143"],["\u6d41\u52a8\u8d1f\u503a\u5ef6\u9012\u6536\u5165","\u4e07\u7f8e\u5143"],["\u6d41\u52a8\u8d1f\u503a\u7279\u6b8a\u9879\u76ee","\u4e07\u7f8e\u5143"],["\u6d41\u52a8\u8d1f\u503a\u5408\u8ba1","\u4e07\u7f8e\u5143"],["\u975e\u6d41\u52a8\u8d1f\u503a\u7279\u6b8a\u9879\u76ee","\u4e07\u7f8e\u5143"],["\u975e\u6d41\u52a8\u8d1f\u503a\u5408\u8ba1","\u4e07\u7f8e\u5143"],["\u8d1f\u503a\u5408\u8ba1","\u4e07\u7f8e\u5143"],["\u5f52\u5c5e\u4e8e\u6bcd\u516c\u53f8\u80a1\u4e1c\u6743\u76ca\u5408\u8ba1","\u4e07\u7f8e\u5143"],["\u5f52\u5c5e\u4e8e\u5c11\u6570\u80a1\u4e1c\u6743\u76ca","\u4e07\u7f8e\u5143"],["\u80a1\u4e1c\u6743\u76ca\u5408\u8ba1","\u4e07\u7f8e\u5143"]],"report":[["2017-03-31<br>2017\u5e74\u4e00\u5b63\u62a5","2016-12-31<br>2016\u5e74\u5e74\u62a5","2016-09-30<br>2016\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2016-06-30<br>2016\u5e74\u4e2d\u62a5","2016-03-31<br>2016\u5e74\u4e00\u5b63\u62a5","2015-12-31<br>2015\u5e74\u5e74\u62a5","2015-09-30<br>2015\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2015-06-30<br>2015\u5e74\u4e2d\u62a5","2015-03-31<br>2015\u5e74\u4e00\u5b63\u62a5","2014-12-31<br>2014\u5e74\u5e74\u62a5","2014-09-30<br>2014\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2014-06-30<br>2014\u5e74\u4e2d\u62a5","2014-03-31<br>2014\u5e74\u4e00\u5b63\u62a5","2013-12-31<br>2013\u5e74\u5e74\u62a5","2013-09-30<br>2013\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2013-06-30<br>2013\u5e74\u4e2d\u62a5","2013-03-31<br>2013\u5e74\u4e00\u5b63\u62a5","2012-12-31<br>2012\u5e74\u5e74\u62a5","2011-12-31<br>2011\u5e74\u5e74\u62a5"],["44420.30","39595.40","47942.90","39651.70","37343.20","33587.90","35329.70","33710.40","45254.10","44987.60","52403.60","49865.70","46621.20","49877.80","","","","12275.40",""],["22573.40","36476.60","18184.10","12994.20","24329.80","23744.00","20377.60","21863.30","28437.20","28346.20","35874.40","24358.00","20620.10","24643.60","","","","290.60",""],["21846.90","3118.80","29758.80","26657.50","13013.40","9843.90","14952.10","11847.10","16816.90","16641.40","16529.20","25507.70","26001.10","25234.20","","","","11984.80",""],["12991.40","11605.40","11634.10","11458.50","9014.70","12023.00","10254.30","12754.80","13326.20","12021.00","6982.50","9588.00","6007.10","4730.40","","","","2592.90",""],["12781.30","6666.40","5197.00","4819.10","5832.90","4229.50","3790.20","3732.60","2215.40","1610.40","2005.50","1108.60","764.70","569.30","","","","",""],["496.20","1856.50","","","","","387.80","","238.00","","","","","","","","","230.70",""],["70689.20","59723.70","64774.00","55929.30","52190.80","49840.40","49762.00","50197.80","61033.70","58619.00","61391.60","60562.30","53393.00","55177.50","","","","15176.50",""],["2393.50","2281.60","1994.70","2031.20","2257.00","2285.00","2405.10","2620.10","2929.10","3087.40","3274.10","3495.30","3454.70","3570.20","","","","4945.20",""],["1145.30","1136.60","1198.60","1219.90","1272.40","1308.30","1402.00","1443.00","1481.20","1519.10","1004.30","1032.30","1030.80","1058.80","","","","",""],["42067.40","39993.30","28448.10","29371.30","29979.40","29467.90","22583.90","22720.00","4645.40","4519.90","2178.40","1356.10","1353.80","550.00","","","","356.50",""],["758.80","559.20","769.10","524.20","559.40","1017.30","2434.90","684.60","302.30","32.70","1431.20","354.10","47.90","336.90","","","","77.60",""],["46365.00","43970.70","32410.50","33146.60","34068.20","34078.50","28825.90","27467.70","9358.00","9159.10","7888.00","6237.80","5887.20","5515.90","","","","5379.30",""],["117054.20","103694.40","97184.50","89075.90","86259.00","83918.90","78587.90","77665.50","70391.70","67778.10","69279.60","66800.10","59280.20","60693.40","","","","20555.80",""],["6032.30","4899.70","4206.10","3046.10","4287.40","4045.60","227.60","30.80","226.10","242.00","223.30","292.50","74.00","82.40","","","","541.30",""],["23299.30","18014.20","15544.60","13442.90","10623.00","11704.00","14696.70","14451.30","10871.50","8747.80","8736.80","7066.30","5208.70","5641.40","","","","1826.90",""],["5705.60","4896.40","4894.00","3574.30","3735.70","3909.10","3193.30","2391.50","2116.20","2095.70","1983.20","1565.90","1457.10","1503.10","","","","239.30",""],["","","1243.40","1761.70","2606.10","1218.80","","1127.70","","171.70","2543.20","1989.60","33301.50","29722.60","","","","39339.10",""],["35037.20","27810.30","25888.10","21825.00","21252.20","20877.50","18117.60","18001.30","13213.80","11257.20","13486.50","10914.30","40041.30","36949.50","","","","41946.60",""],["135.60","148.30","192.50","206.50","223.80","238.50","57.90","68.60","78.00","87.30","55.00","61.20","67.90","","","","","",""],["135.60","148.30","192.50","206.50","223.80","238.50","57.90","68.60","78.00","87.30","55.00","61.20","67.90","76.80","","","","",""],["35172.80","27958.60","26080.60","22031.50","21476.00","21116.00","18175.50","18069.90","13291.80","11344.50","13541.50","10975.50","40109.20","37026.30","","","","41946.60",""],["81494.90","75322.50","70662.60","66458.90","64037.40","62067.20","59635.70","58776.10","56989.30","56328.10","55703.10","55787.40","-28790.20","-24294.10","","","","-21390.80",""],["386.50","413.30","441.30","585.50","745.60","735.70","776.70","819.50","110.60","105.50","35.00","37.20","","","","","","",""],["81881.40","75735.80","71103.90","67044.40","64783.00","62802.90","60412.40","59595.60","57099.90","56433.60","55738.10","55824.60","19171.00","23667.10","","","","-21390.80",""]]}</p>
    现金与现金等价物 idx2,单位：万元/万美元
    股东权益合计: idx-1，单位：万元/万美元
    非流动负债合计：idx-5，单位：万元/万美元
    流动负债合计:idx-7，单位：万元/万美元
    流动资产合计:idx7，单位：万元/万美元

    利润表：
    <p id="benefit">{"title":["\u93c3\u5815\u68ff\\\u7ec9\u6220\u6d30",["\u8425\u4e1a\u6536\u5165","\u4e07\u7f8e\u5143"],["\u8425\u4e1a\u603b\u6536\u5165","\u4e07\u7f8e\u5143"],["\u8425\u4e1a\u6210\u672c","\u4e07\u7f8e\u5143"],["\u8425\u4e1a\u6bdb\u5229\u6da6","\u4e07\u7f8e\u5143"],["\u5e02\u573a\u3001\u9500\u552e\u548c\u7ba1\u7406\u8d39\u7528","\u4e07\u7f8e\u5143"],["\u7814\u53d1\u8d39\u7528","\u4e07\u7f8e\u5143"],["\u8425\u4e1a\u8d39\u7528\u5408\u8ba1","\u4e07\u7f8e\u5143"],["\u8425\u4e1a\u5229\u6da6","\u4e07\u7f8e\u5143"],["\u51c0\u5229\u606f\u8d39\u7528","\u4e07\u7f8e\u5143"],["\u5176\u4e2d\uff1a\u5229\u606f\u6536\u5165","\u4e07\u7f8e\u5143"],["\u5229\u606f\u652f\u51fa","\u4e07\u7f8e\u5143"],["\u6301\u7eed\u7ecf\u8425\u4e1a\u52a1\u7279\u6b8a\u9879\u76ee","\u4e07\u7f8e\u5143"],["\u7a0e\u524d\u5229\u6da6","\u4e07\u7f8e\u5143"],["\u6240\u5f97\u7a0e","\u4e07\u7f8e\u5143"],["\u7a0e\u540e\u5229\u6da6","\u4e07\u7f8e\u5143"],["\u51c0\u5229\u6da6","\u4e07\u7f8e\u5143"],["\u5f52\u5c5e\u4e8e\u5c11\u6570\u80a1\u4e1c\u7684\u51c0\u5229\u6da6","\u4e07\u7f8e\u5143"],["\u5f52\u5c5e\u4e8e\u6bcd\u516c\u53f8\u80a1\u4e1c\u7684\u51c0\u5229\u6da6","\u4e07\u7f8e\u5143"],["\u57fa\u672c\u6bcf\u80a1\u6536\u76ca","\u7f8e\u5143"],["\u7a00\u91ca\u6bcf\u80a1\u6536\u76ca","\u7f8e\u5143"]],"report":[["2017-03-31<br>2017\u5e74\u4e00\u5b63\u62a5","2016-12-31<br>2016\u5e74\u5e74\u62a5","2016-09-30<br>2016\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2016-06-30<br>2016\u5e74\u4e2d\u62a5","2016-03-31<br>2016\u5e74\u4e00\u5b63\u62a5","2015-12-31<br>2015\u5e74\u5e74\u62a5","2015-09-30<br>2015\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2015-06-30<br>2015\u5e74\u4e2d\u62a5","2015-03-31<br>2015\u5e74\u4e00\u5b63\u62a5","2014-12-31<br>2014\u5e74\u5e74\u62a5","2014-09-30<br>2014\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2014-06-30<br>2014\u5e74\u4e2d\u62a5","2014-03-31<br>2014\u5e74\u4e00\u5b63\u62a5","2013-12-31<br>2013\u5e74\u5e74\u62a5","2013-09-30<br>2013\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2013-06-30<br>2013\u5e74\u4e2d\u62a5","2013-03-31<br>2013\u5e74\u4e00\u5b63\u62a5","2012-12-31<br>2012\u5e74\u5e74\u62a5","2012-09-30<br>2012\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2012-06-30<br>2012\u5e74\u4e2d\u62a5","2012-03-31<br>2012\u5e74\u4e00\u5b63\u62a5","2011-12-31<br>2011\u5e74\u5e74\u62a5","2011-09-30<br>2011\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2011-06-30<br>2011\u5e74\u4e2d\u62a5","2011-03-31<br>2011\u5e74\u4e00\u5b63\u62a5","2010-12-31<br>2010\u5e74\u5e74\u62a5","2010-09-30<br>2010\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2010-06-30<br>2010\u5e74\u4e2d\u62a5","2010-03-31<br>2010\u5e74\u4e00\u5b63\u62a5","2009-12-31<br>2009\u5e74\u5e74\u62a5","2009-09-30<br>2009\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2009-06-30<br>2009\u5e74\u4e2d\u62a5","2009-03-31<br>2009\u5e74\u4e00\u5b63\u62a5","2008-12-31<br>2008\u5e74\u5e74\u62a5","2008-09-30<br>2008\u5e74\u4e09\u5b63\u62a5(\u7d2f\u8ba1)","2007-12-31<br>2007\u5e74\u5e74\u62a5","2006-12-31<br>2006\u5e74\u5e74\u62a5"],["269627.00","700013.20","471550.10","241706.50","114704.80","404602.50","283164.50","189485.60","93988.00","319835.60","224169.50","138989.10","62054.20","201349.60","139827.70","96693.10","56179.20","41325.60","10692.40","5682.00","3016.70","20424.20","16486.70","10720.10","4903.00","11674.40","8045.80","4921.70","2081.20","11194.30","9335.80","4783.10","2088.60","1474.20","58.00","7.30",""],["269627.00","700013.20","471550.10","241706.50","114704.80","404602.50","283164.50","189485.60","93988.00","319835.60","224169.50","138989.10","62054.20","201349.60","139827.70","96693.10","56179.20","41325.60","10692.40","5682.00","3016.70","20424.20","16486.70","10720.10","4903.00","11674.40","8045.80","4921.70","2081.20","11194.30","9335.80","4783.10","2088.60","1474.20","58.00","7.30",""],["202832.40","540087.50","355152.20","188982.10","89458.00","312252.20","212670.60","142141.30","67980.70","231668.50","162172.10","102176.80","46541.40","155723.40","109860.40","77012.80","46547.20","38318.90","10071.40","4184.80","1995.70","14264.70","11110.70","7066.50","3100.20","8601.30","6104.80","3910.40","1696.00","10240.80","8560.40","4777.60","2293.20","1588.30","1.90","0.90",""],["66794.60","159925.70","116397.90","52724.40","25246.80","92350.30","70493.90","47344.30","26007.30","88167.10","61997.40","36812.30","15512.80","45626.20","29967.30","19680.30","9632.00","3006.70","621.00","1497.20","1021.00","6159.50","5376.00","3653.60","1802.80","3073.10","1941.00","1011.30","385.20","953.50","775.40","5.50","-204.60","-114.10","56.10","6.40",""],["60345.50","143218.90","97617.30","63936.20","31821.00","92223.20","63357.80","39721.10","19536.50","60366.00","40669.00","25158.30","11755.10","28556.90","18408.00","10700.80","4704.50","15037.20","10446.40","6666.50","3058.20","10410.20","7654.50","4892.80","2421.20","8457.30","5922.40","3879.20","1658.50","4215.00","2558.70","1485.40","660.70","2364.90","1395.30","1724.40","543.60"],["32204.00","83440.80","58844.80","37414.60","18248.20","71790.00","52765.70","34886.60","16715.40","46470.00","32513.50","18926.20","8154.40","23197.60","16352.30","10717.10","5485.90","27397.80","20514.60","14324.50","6839.10","20898.10","14777.60","9369.30","4116.20","9299.60","5537.90","2868.10","1326.50","1928.20","1113.90","988.20","794.10","5371.40","4188.80","6275.30","2499.50"],["102175.10","245687.70","169197.60","109700.80","54006.60","175747.50","124071.10","79657.20","38890.90","116812.00","80310.10","48335.90","21083.70","55029.00","37421.10","23436.40","10201.20","42431.60","30963.50","20989.50","9894.80","31287.10","22415.50","14253.50","6533.40","17830.30","11540.00","6807.20","3003.20","6380.40","3913.50","2717.90","1593.40","8058.10","5800.30","7824.80","2991.60"],[-25754.9,-66734,-40064.2,-48626.4,-24822.4,-71662.9,-45629.6,-27263.4,-10244.6,-18668.9,-11185.1,-7272.2,-4396.7,-6128.3,-4793,-1737.6,-558.4,-39428.3,-30340,-19493.8,-8876.3,-25148.8,-17056.1,-10608.5,-4734.6,-14683.8,-9519.3,-5736,-2599.8,-5189.7,-2897.2,-2468.1,-1659.4,-7850.4,-5528,-7993.3,-3043.1],["9625.60","19028.00","12735.50","8350.00","3937.40","11734.30","7947.60","5049.50","2639.00","9976.00","7127.60","4251.40","1174.20","3274.50","2660.80","2018.50","10.80","-3.40","2.50","-1.50","-2.50","-21.20","-16.60","-8.60","-4.00","73.40","79.70","59.90","18.20","237.20","240.90","244.30","138.60","321.80","216.20","-174.90","-51.50"],["309.00","853.00","635.10","349.30","125.10","150.80","75.80","43.10","18.40","112.60","90.70","60.80","14.10","18.90","9.70","4.90","1.00","28.80","20.30","16.40","9.00","25.50","16.60","8.60","4.00","25.80","19.50","9.50","4.80","15.90","9.70","4.50","1.60","52.90","48.60","174.90","93.80"],["9934.60","19881.00","13370.60","8699.30","4062.50","11885.10","8023.40","5092.60","2657.40","10088.60","7218.30","4312.20","1188.30","3293.40","2670.50","2023.40","11.80","25.40","22.80","14.90","6.50","4.30","","","","99.20","99.20","69.40","23.00","253.10","250.60","248.80","140.20","374.70","264.80","","42.30"],["-1809.80","11127.20","-995.20","180.40","917.70","-4165.20","-2450.30","-907.20","-2230.50","181.30","240.10","549.20","671.80","2260.20","1801.80","1875.90","1709.10","-182.80","-257.30","-38.50","-107.60","-264.60","-215.00","-155.60","-148.50","-658.30","-677.00","-995.00","-322.10","-144.50","-32.00","25.70","197.20","-96.30","23.10","13.70","5.90"],["-37190.30","-74634.80","-53794.90","-56796.00","-27842.10","-87562.40","-56027.50","-33220.10","-15114.10","-28463.60","-18072.60","-10974.40","-4899.10","-7142.60","-5652.00","-1880.20","1139.90","-39607.70","-30599.80","-19530.80","-8981.40","-25392.20","-17254.50","-10755.50","-4879.10","-15415.50","-10276.00","-6790.90","-2940.10","-5571.40","-3170.10","-2686.70","-1600.80","-8268.50","-5721.10","-7804.70","-2985.70"],["2527.80","2669.80","1562.80","749.50","384.60","1303.90","799.10","620.70","304.00","940.40","568.50","195.80","80.90","258.80","123.00","45.20","15.10","13.60","28.40","16.80","5.90","48.90","37.70","28.90","15.00","17.30","21.00","12.70","11.80","2.60","-20.30","1.60","0.80","9.70","7.30","11.00","10.00"],["-39718.10","-77304.60","-55357.70","-57545.50","-28226.70","-88866.30","-56826.60","-33840.80","-15418.10","-29404.00","-18641.10","-11170.20","-4980.00","-7401.40","-5775.00","-1925.40","1124.80","-39621.30","-30628.20","-19547.60","-8987.30","-25441.10","-17292.20","-10784.40","-4894.10","-15432.80","-10297.00","-6803.60","-2951.90","-5574.00","-3149.80","-2688.30","-1601.60","-8278.20","-5728.40","-7815.70","-2995.70"],["-39718.10","-77304.60","-55357.70","-57545.50","-28226.70","-88866.30","-56826.60","-33840.80","-15418.10","-29404.00","-18641.10","-11170.20","-4980.00","-7401.40","-5775.00","-1925.40","1124.80","-39621.30","-30628.20","-19547.60","-8987.30","-25441.10","-17292.20","-10784.40","-4894.10","-15432.80","-10297.00","-6803.60","-2951.90","-5574.00","-3149.80","-2688.30","-1601.60","-8278.20","-5728.40","-7815.70","-2995.70"],["-6690.40","-9813.20","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],["-33027.70","-67491.40","-55357.70","-57545.50","-28226.70","-88866.30","-56826.60","-33840.80","-15418.10","-29404.00","-18641.10","-11170.20","-4980.00","-7401.40","-5775.00","-1925.40","1124.80","-39621.30","-30628.20","-19547.60","-8987.30","-25441.10","-17292.20","-10784.40","-4894.10","-15432.80","-10297.00","-6803.60","-2951.90","-5574.00","-3149.80","-2688.30","-1601.60","-8278.20","-5728.40","-7815.70","-2995.70"],["-2.04","-4.68","-3.94","-4.22","-2.13","-6.93","-4.47","-2.68","-1.22","-2.36","-1.50","-0.90","-0.40","-0.62","-0.49","-0.17","0.10","-3.69","-2.91","-1.86","-0.86","-2.53","-1.75","-1.12","-0.51","-3.04","-2.86","-9.10","-4.04","-7.94","-1.51","-3.87","-2.31","-4.15","-2.88","-7.56","-3.39"],["-2.04","-4.68","-3.94","-4.22","-2.13","-6.93","-4.47","-2.68","-1.22","-2.36","-1.50","-0.90","-0.40","-0.62","-0.49","-0.17","0.00","-3.69","-2.91","-1.86","-0.86","-2.53","-1.75","-1.12","-0.51","-3.04","-2.86","-9.10","-4.04","-7.94","-1.51","-3.87","-2.31","-4.15","-2.88","-7.56","-3.39"]]}</p>
    营业收入：idx1，单位：万元/万美元
    基本每股收益:idx-2,fd_profit_base_share，单位：元/美元
    稀释每股收益:idx-1

=end
  def self.import_us_finRpt stock
    regexp = /([A-Z]+)/
    code = stock.code.match(regexp)[1]
    url = "http://stockpage.10jqka.com.cn/#{code}/finance/"
    rsp = Net::HTTP.get(URI.parse(url))
    regexp = /<p id="benefit">(.*)<\/p>/
    match_data = rsp.match(regexp)
    unless match_data
      return []
    end

    json_str = match_data[1]
    benefit_json = ActiveSupport::JSON.decode(json_str)
    benefit_report = benefit_json["report"]

    regexp = /<p id="debt">(.*)<\/p>/
    match_data = rsp.match(regexp)
    unless match_data
      return []
    end

    debt_json_str = match_data[1]
    debt_json = ActiveSupport::JSON.decode(debt_json_str)
    debt_report = debt_json["report"]


    records = []
    cols = []
    # fd_year, fd_type
    # "2016-06-30<br>2016\u5e74\u4e2d\u62a5"
    benefit_report[0].each_with_index  do |cell,idx|
      unless cell.to_s.match(/^20[012][0-9]/)
        next
      end

      fd_repdate, fd_year_msg = cell.split("<br>")
      if fd_year_msg.end_with? "一季报"
        fd_type = FinReport::TYPE_Q1
      elsif fd_year_msg.end_with? "中报"
        fd_type = FinReport::TYPE_SUM_Q2
      elsif fd_year_msg.end_with? "三季报(累计)"
        fd_type = FinReport::TYPE_SUM_Q3
      elsif fd_year_msg.end_with? "年报"
        fd_type = FinReport::TYPE_ANNUAL
      else
        next
      end

      fd_year = fd_year_msg.match(/(\d+)/)[1]
      cols << idx
      records << {fd_code:stock.code, fd_year:fd_year, fd_repdate:fd_repdate, fd_type:fd_type}
    end

    # fd_turnover
    cols.each_with_index do |col,idx|
      records[idx][:fd_turnover] = benefit_report[1][col]
      records[idx][:fd_profit_base_share] = benefit_report[-2][col]
      records[idx][:fd_profit_after_share] = benefit_report[-1][col]

      #现金与现金等价物 idx2
      #股东权益合计: idx-1
      #非流动负债合计：idx-7
      #流动负债合计:idx-11
      #流动资产合计:idx7
      #:fd_dividend_base_share, :fd_non_liquid_debts, :fd_stkholder_rights,
      #:fd_liquid_debts, :fd_liquid_assets, :fd_cash_and_deposit
      records[idx][:fd_cash_and_deposit] = debt_report[2][col]
      records[idx][:fd_stkholder_rights] = debt_report[-1][col]
      records[idx][:fd_non_liquid_debts] = debt_report[-7][col]
      records[idx][:fd_liquid_debts] = debt_report[-11][col]
      records[idx][:fd_liquid_assets] = debt_report[8][col]
    end

    records
  end

=begin
  港股
  综合损益表：http://web.ifzq.gtimg.cn/appstock/hk/HkInfo/getFinReport?type=3&reporttime_type=-1&code=00700&&startyear=2015&endyear=2016
  基本每股盈利:fd_profit_base_share，单元：元，港币/人民币
  每股股息：fd_dividend_base_share，单元：元，港币/人民币

  资产负债表：http://web.ifzq.gtimg.cn/appstock/hk/HkInfo/getFinReport?type=1&reporttime_type=-1&code=00700&&startyear=2015&endyear=2016
  非流动负债: fd_non_liquid_debts，单位：百万
  股东权益: fd_stkholder_rights，单位：百万

  流动负债:fd_liquid_debts，单位：百万
  流动资产: fd_liquid_assets，单位：百万

  现金及银行结存:fd_cash_and_bankdeposit，单位：百万

  d_type=1, 年报
  3 Q2
  4,Q1
  2，Q3
=end
  def self.import_hk_finRpt stock
    code = stock.code.match(/(\d+)/)[1]
    url = "http://web.ifzq.gtimg.cn/appstock/hk/HkInfo/getFinReport?type=3&reporttime_type=-1&code=#{code}&&startyear=2010&endyear=#{Time.now.year}"
    rsp = Net::HTTP.get(URI.parse(url))
    json_str = rsp
    benefit_json = ActiveSupport::JSON.decode(json_str)
    benefit_items = benefit_json["data"]["data"]

    url = "http://web.ifzq.gtimg.cn/appstock/hk/HkInfo/getFinReport?type=1&reporttime_type=-1&code=#{code}&&startyear=2010&endyear=#{Time.now.year}"
    rsp = Net::HTTP.get(URI.parse(url))
    json_str = rsp
    debit_json = ActiveSupport::JSON.decode(json_str)
    debit_items = debit_json["data"]["data"]

    records = {}
    benefit_items.each do |item|
      uk = "#{item[:fd_code]},#{item[:fd_year]},#{item[:fd_type]}"
      record = {fd_code:stock.code, fd_year:item["fd_year"], fd_repdate:item["fd_repdate"], fd_type:item["fd_type"],
       fd_turnover:item["fd_turnover"],fd_profit_base_share:item["fd_profit_base_share"],fd_profit_after_share:item["fd_profit_after_share"],
                  fd_dividend_base_share:item["fd_dividend_base_share"]
      }

      records[uk] = record
    end

    debit_items.each do |item|
      uk = "#{item[:fd_code]},#{item[:fd_year]},#{item[:fd_type]}"
      record = records[uk]
      unless record
        puts "#{uk} cant found in benefit report"
        next
      end

      #:fd_dividend_base_share, :fd_non_liquid_debts, :fd_stkholder_rights,
      #:fd_liquid_debts, :fd_liquid_assets, :fd_cash_and_deposit
      record[:fd_non_liquid_debts] = item["fd_non_liquid_debts"]
      record[:fd_stkholder_rights] = item["fd_stkholder_rights"]
      record[:fd_liquid_debts] = item["fd_liquid_debts"]
      record[:fd_liquid_assets] = item["fd_liquid_assets"]
      record[:fd_cash_and_deposit] = item["fd_cash_and_bankdeposit"]
    end
    records.values
  end
end
